<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>₿AZAR TCM — автообъявления</title>
<style>
  :root{
    --accent:#0b6efd;
    --bg:#f5f7f8;
    --card:#ffffff;
    --muted:#666;
    --radius:10px;
    --gap:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:var(--bg);
    color:#222;
  }
  header{
    background:linear-gradient(90deg,var(--accent),#1466d6);
    color:#fff;
    padding:18px 20px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:30;
  }
  .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px;}
  .logo{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;}
  .search{flex:1;max-width:760px;display:flex;gap:8px;}
  .search input{flex:1;padding:10px 12px;border-radius:8px;border:none;outline:none;}
  .search button{background:#fff;border:none;color:var(--accent);padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer;}
  .wrap{padding:20px;max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:var(--gap);}
  @media(max-width:900px){.wrap{grid-template-columns:1fr;padding:12px;}header{flex-wrap:wrap;}.search{max-width:none;width:100%}}
  .panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(12,20,40,0.06);}
  .panel h3{margin:0 0 10px;font-size:16px}
  .field{margin-bottom:10px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input[type="number"],input[type="text"]{width:100%;padding:8px 10px;border-radius:6px;border:1px solid #e6eef8}
  .row{display:flex;gap:8px}
  .small{flex:1}
  .checkboxes{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 8px;border-radius:8px;background:#f1f6ff;border:1px solid #e6f0ff;font-size:13px;cursor:pointer}
  .chip.active{background:linear-gradient(180deg,#dbeaff,#c9e0ff);border-color:#a6c8ff}
  .actions{display:flex;gap:8px;margin-top:8px}
  .btn{flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .btn.ghost{background:#f3f7fb;color:var(--muted);border:1px solid #e6eef8}
  .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
  .card{background:var(--card);border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(12,20,40,0.05);display:flex;flex-direction:column;}
  .thumb{width:100%;height:140px;border-radius:10px;overflow:hidden;margin-bottom:8px;background:#efefef;display:flex;align-items:center;justify-content:center;color:#999;font-weight:600;}
  .title{font-weight:700;font-size:15px}
  .price{color:#0a8d3b;font-weight:800}
  .muted{color:var(--muted);font-size:13px}
  .badge{background:#f3f7fb;border-radius:8px;padding:6px 8px;font-size:12px;color:#444}
  .empty{padding:40px;border-radius:10px;text-align:center;color:var(--muted);background:#fff}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">₿</div>
    <div>₿AZAR <span style="opacity:0.9;margin-left:6px;font-weight:600">TCM</span></div>
  </div>

  <div class="search">
    <input id="q" placeholder="Поиск: марка, модель..." />
    <button id="btnSearch">Найти</button>
  </div>

  <div style="min-width:140px;text-align:right;color:#fff;font-size:13px">Рынок автомобилей</div>
</header>

<main class="wrap">
  <aside class="panel">
    <h3>Фильтры</h3>
    <div class="field">
      <label>Марка</label>
      <select id="filterBrand"><option value="">— Все марки —</option></select>
    </div>
    <div class="field">
      <label>Цена (сом)</label>
      <div class="row">
        <input id="priceMin" class="small" type="number" placeholder="От" min="0" />
        <input id="priceMax" class="small" type="number" placeholder="До" min="0" />
      </div>
    </div>
    <div class="actions">
      <button id="apply" class="btn">Применить</button>
      <button id="clear" class="btn ghost">Сбросить</button>
    </div>
  </aside>

  <section>
    <div class="panel">
      <div class="results-header">
        <div><strong>Результаты</strong></div>
        <select id="sortBy">
          <option value="recent">Свежее</option>
          <option value="price-asc">Цена ↑</option>
          <option value="price-desc">Цена ↓</option>
        </select>
      </div>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">Объявления не найдены</div>
    </div>
  </section>
</main>

<script>
let ADS = [];

async function loadAds(){
  const res = await fetch('/api/ads');
  ADS = await res.json();
  populateFilters();
  applyFilters();
}

function populateFilters(){
  const brands = [...new Set(ADS.map(a=>a.brand))].sort();
  const elBrand = document.getElementById('filterBrand');
  brands.forEach(b=>{
    const opt = document.createElement('option');
    opt.value=b; opt.textContent=b;
    elBrand.appendChild(opt);
  });
}

function getFilters(){
  return {
    brand: document.getElementById('filterBrand').value,
    min: Number(document.getElementById('priceMin').value)||0,
    max: Number(document.getElementById('priceMax').value)||Infinity,
    q: document.getElementById('q').value.trim().toLowerCase(),
    sort: document.getElementById('sortBy').value
  };
}

function applyFilters(){
  const f = getFilters();
  let res = ADS.filter(a=>
    (!f.brand || a.brand===f.brand) &&
    a.price>=f.min && a.price<=f.max &&
    (a.brand.toLowerCase().includes(f.q) || a.model.toLowerCase().includes(f.q))
  );

  if(f.sort==='price-asc') res.sort((x,y)=>x.price-y.price);
  else if(f.sort==='price-desc') res.sort((x,y)=>y.price-x.price);
  else res.sort((x,y)=>y.id-x.id);

  render(res);
}

function render(items){
  const grid=document.getElementById('grid');
  const empty=document.getElementById('empty');
  grid.innerHTML='';
  if(!items.length){empty.style.display='block';return;}
  empty.style.display='none';
  items.forEach(a=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div class="thumb">${a.photo ? `<img src="${a.photo}" style="width:100%;height:100%;object-fit:cover;">` : a.brand}</div>
      <div class="title">${a.brand} ${a.model} • ${a.year}</div>
      <div class="price">${a.price.toLocaleString()} ${a.currency}</div>
      <div class="muted">${a.color} • ${a.body}</div>
      <div style="margin-top:8px">
        <button class="btn ghost" onclick="alert('Просмотр: ${a.brand} ${a.model}')">Посмотреть</button>
        <button class="btn" onclick="window.open('https://t.me/BazarTcmBot','_blank')">Связаться</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

document.getElementById('apply').onclick=applyFilters;
document.getElementById('clear').onclick=()=>{document.getElementById('filterBrand').value='';document.getElementById('priceMin').value='';document.getElementById('priceMax').value='';document.getElementById('q').value='';applyFilters();};
document.getElementById('btnSearch').onclick=applyFilters;
document.getElementById('sortBy').onchange=applyFilters;
document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter')applyFilters();});

loadAds();
</script>
</body>
</html>
